<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Firebase ì‹¤ì‹œê°„ ì±„íŒ… ì•± (v3)</title>
<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
:root {
  --bg-color: #f4f4f4;
  --container-bg: #fff;
  --header-bg: #007bff;
  --header-text: #fff;
  --window-bg: #fff;
  --window-border: #ddd;
  --message-bg: #e9ecef;
  --message-user: #495057;
  --message-text: #212529;
  --form-bg: #f8f9fa;
  --input-bg: #fff;
  --input-border: #ccc;
  --input-text: #212529;
  --button-bg: #007bff;
  --button-text: #fff;
  --button-hover-bg: #0056b3;
  --shadow-color: rgba(0, 0, 0, 0.1);
}

body {
  font-family: 'Segoe UI', sans-serif;
  background-color: var(--bg-color);
  color: var(--message-text);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  transition: background-color 0.3s, background-image 0.3s;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

.chat-container {
  width: 100%;
  max-width: 500px;
  background-color: var(--container-bg);
  border-radius: 8px;
  box-shadow: 0 4px 12px var(--shadow-color);
  display: flex;
  flex-direction: column;
  height: 80vh;
  max-height: 700px;
  transition: background-color 0.3s, box-shadow 0.3s;
}

header {
  background-color: var(--header-bg);
  color: var(--header-text);
  padding: 15px;
  text-align: center;
  font-size: 1.2rem;
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}

header > span {
  flex-grow: 1;
}

#theme-select {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  padding: 4px 6px;
  border-radius: 4px;
  border: 1px solid var(--input-border);
  background-color: var(--input-bg);
  color: var(--input-text);
  font-size: 0.8rem;
}

#reset-db-button {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  background-color: #dc3545;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: bold;
}

.chat-window {
  flex-grow: 1;
  padding: 20px;
  overflow-y: auto;
  border-bottom: 1px solid var(--window-border);
  background-color: var(--window-bg);
  transition: background-color 0.3s;
}

.message-item {
  margin-bottom: 15px;
  padding: 10px;
  background-color: var(--message-bg);
  border-radius: 8px;
  max-width: 80%;
}

.message-username {
  display: block;
  font-size: 0.8em;
  font-weight: bold;
  color: var(--message-user);
  margin-bottom: 4px;
}

.message-text {
  font-size: 0.95em;
  color: var(--message-text);
}

.message-image {
  max-width: 100%;
  border-radius: 5px;
  margin-top: 5px;
  cursor: pointer;
}

#chat-form {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  padding: 15px;
  background-color: var(--form-bg);
  border-top: 1px solid var(--window-border);
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
}

#username-input {
  width: 90px;
  padding: 8px;
  margin-right: 8px;
  border: 1px solid var(--input-border);
  border-radius: 4px;
  background-color: var(--input-bg);
  color: var(--input-text);
}

#message-input {
  flex-grow: 1;
  padding: 8px;
  border: 1px solid var(--input-border);
  border-radius: 4px;
  margin-right: 8px;
}

#font-size-select, #color-picker {
  margin-right: 8px;
  padding: 6px;
  border-radius: 4px;
  border: 1px solid var(--input-border);
  cursor: pointer;
}

#image-upload-input, #bg-upload-input {
  display: none;
}

#image-upload-label, #bg-upload-label {
  padding: 4px 8px;
  border: 1px solid var(--input-border);
  background-color: var(--input-bg);
  border-radius: 4px;
  cursor: pointer;
  margin-right: 8px;
  font-size: 1.2rem;
}

#send-button {
  padding: 8px 14px;
  border: none;
  background-color: var(--button-bg);
  color: var(--button-text);
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}
</style>
</head>

<body class="theme-light">
  <div class="chat-container">
    <header>
      <select id="theme-select">
        <option value="light">ë¼ì´íŠ¸</option>
        <option value="dark">ë‹¤í¬</option>
        <option value="pastel">íŒŒìŠ¤í…”</option>
      </select>
      <span>Firebase ì‹¤ì‹œê°„ ì±„íŒ…ë°©</span>
      <button id="reset-db-button">ì´ˆê¸°í™”</button>
    </header>

    <div class="chat-window" id="chat-window">
      <ul id="message-list"></ul>
    </div>

    <form id="chat-form">
      <input type="text" id="username-input" placeholder="ì´ë¦„" required />
      <select id="font-size-select">
        <option value="12px">12</option>
        <option value="14px" selected>14</option>
        <option value="16px">16</option>
        <option value="18px">18</option>
        <option value="20px">20</option>
      </select>
      <input type="color" id="color-picker" value="#000000" />
      <input type="file" id="image-upload-input" accept="image/*" />
      <label for="image-upload-input" id="image-upload-label">ğŸ–¼ï¸</label>

      <!-- âœ… ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¶”ê°€ -->
      <input type="file" id="bg-upload-input" accept="image/*" />
      <label for="bg-upload-input" id="bg-upload-label" title="ë°°ê²½ ì´ë¯¸ì§€ ë³€ê²½">ğŸŒ†</label>

      <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." required />
      <button type="submit" id="send-button">ì „ì†¡</button>
    </form>
  </div>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      serverTimestamp,
      query,
      orderByChild,
      remove
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB5TAYEoAEawpaYr1tR373OhCYumOc4B7o",
      authDomain: "chat-33290.firebaseapp.com",
      databaseURL: "https://chat-33290-default-rtdb.firebaseio.com",
      projectId: "chat-33290",
      messagingSenderId: "894357766876",
      appId: "1:894357766876:web:bd27cd3f1da7e29b3eaa19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "messages");

    const usernameInput = document.getElementById("username-input");
    const messageInput = document.getElementById("message-input");
    const colorPicker = document.getElementById("color-picker");
    const fontSizeSelect = document.getElementById("font-size-select");
    const messageList = document.getElementById("message-list");
    const chatWindow = document.getElementById("chat-window");
    const themeSelect = document.getElementById("theme-select");
    const resetButton = document.getElementById("reset-db-button");
    const imageUploadInput = document.getElementById("image-upload-input");
    const bgUploadInput = document.getElementById("bg-upload-input");
    const sendButton = document.getElementById("send-button");

    // âœ… í…Œë§ˆ ì €ì¥/ë³µì›
    document.addEventListener("DOMContentLoaded", () => {
      const savedTheme = localStorage.getItem("chatTheme") || "light";
      document.body.className = `theme-${savedTheme}`;
      themeSelect.value = savedTheme;

      const savedBg = localStorage.getItem("chatBackground");
      if (savedBg) document.body.style.backgroundImage = `url('${savedBg}')`;
    });

    themeSelect.addEventListener("change", (e) => {
      const theme = e.target.value;
      document.body.className = `theme-${theme}`;
      localStorage.setItem("chatTheme", theme);
    });

    // âœ… ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ
    bgUploadInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        const base64 = event.target.result;
        document.body.style.backgroundImage = `url('${base64}')`;
        localStorage.setItem("chatBackground", base64);
      };
      reader.readAsDataURL(file);
    });

    // âœ… ë©”ì‹œì§€ ì „ì†¡
    document.getElementById("chat-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const username = usernameInput.value.trim();
      const message = messageInput.value.trim();
      const color = colorPicker.value;
      const size = fontSizeSelect.value;

      if (!username || !message) return alert("ì´ë¦„ê³¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

      push(messagesRef, {
        username,
        message,
        color,
        size,
        timestamp: serverTimestamp()
      });

      messageInput.value = "";
      messageInput.focus();
    });

    // âœ… ì´ë¯¸ì§€/GIF ì—…ë¡œë“œ
    imageUploadInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      const username = usernameInput.value.trim();
      if (!file || !username) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      if (file.size > 5 * 1024 * 1024)
        return alert("5MB ì´í•˜ì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

      sendButton.disabled = true;
      sendButton.textContent = "ì—…ë¡œë“œ ì¤‘...";

      const reader = new FileReader();
      reader.onload = (event) => {
        const base64 = event.target.result;
        push(messagesRef, {
          username,
          imageBase64: base64,
          timestamp: serverTimestamp()
        });
        imageUploadInput.value = "";
        sendButton.disabled = false;
        sendButton.textContent = "ì „ì†¡";
      };
      reader.readAsDataURL(file);
    });

    // âœ… ì‹¤ì‹œê°„ ë©”ì‹œì§€ í‘œì‹œ
    const messagesQuery = query(messagesRef, orderByChild("timestamp"));
    onChildAdded(messagesQuery, (snap) => {
      const data = snap.val();
      const li = document.createElement("li");
      li.className = "message-item";

      const name = document.createElement("span");
      name.className = "message-username";
      name.textContent = data.username || "ìµëª…";
      li.appendChild(name);

      if (data.message) {
        const msg = document.createElement("p");
        msg.className = "message-text";
        msg.textContent = data.message;
        msg.style.color = data.color;
        msg.style.fontSize = data.size;
        li.appendChild(msg);
      }

      if (data.imageBase64) {
        const img = document.createElement("img");
        img.className = "message-image";
        img.src = data.imageBase64;
        img.addEventListener("click", () => window.open(data.imageBase64));
        li.appendChild(img);
      }

      messageList.appendChild(li);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    // âœ… ì´ˆê¸°í™”
    resetButton.addEventListener("click", () => {
      const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸(ë¹„ë°€ë²ˆí˜¸0207)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if (pw === "ë¹„ë°€ë²ˆí˜¸0207") {
        remove(messagesRef);
        messageList.innerHTML = "";
        alert("ì±„íŒ…ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else if (pw) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    });
  </script>
</body>
</html>
