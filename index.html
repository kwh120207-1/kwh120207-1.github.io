<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Firebase ì‹¤ì‹œê°„ ì±„íŒ… ì•± (ê¸€ë¼ìŠ¤ í†µí•©)</title>
<style>
:root{
  --bg-color: #f4f4f4;
  --container-bg: #fff;
  --header-bg: #007bff;
  --header-text: #fff;
  --window-bg: #fff;
  --window-border: #ddd;
  --message-bg: rgba(255,255,255,0.8);
  --message-user: #495057;
  --message-text: #212529;
  --form-bg: #f8f9fa;
  --input-bg: #fff;
  --input-border: #ccc;
  --input-text: #212529;
  --button-bg: #007bff;
  --button-text: #fff;
  --shadow-color: rgba(0,0,0,0.1);
}

*{box-sizing:border-box}
body {
  font-family: 'Segoe UI', sans-serif;
  background-color: var(--bg-color);
  color: var(--message-text);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  transition: background-color .3s, background-image .3s;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  position: relative;
}

/* ì»¨í…Œì´ë„ˆ ê¸°ë³¸ */
.chat-container {
  width: 100%;
  max-width: 500px;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  height: 80vh;
  max-height: 700px;
  transition: background-color .3s, box-shadow .3s;
  position: relative;
  overflow: hidden;
}

/* í—¤ë” */
header {
  background-color: var(--header-bg);
  color: var(--header-text);
  padding: 12px 48px;
  text-align: center;
  font-size: 1.05rem;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}
header > span{flex-grow:1}
#theme-select {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  padding: 4px 6px;
  border-radius: 4px;
  border: 1px solid var(--input-border);
  background-color: var(--input-bg);
  color: var(--input-text);
  font-size: 0.8rem;
}
#reset-db-button {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  background-color: #dc3545;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: bold;
}

/* ì±„íŒ… ìœˆë„ìš° */
.chat-window {
  flex-grow: 1;
  padding: 18px;
  overflow-y: auto;
  border-bottom: 1px solid var(--window-border);
  background-color: var(--window-bg);
  transition: background-color .3s;
}

/* ë©”ì‹œì§€ ì•„ì´í…œ */
#message-list{list-style:none;padding:0;margin:0}
.message-item {
  margin-bottom: 14px;
  padding: 10px;
  border-radius: 10px;
  max-width: 80%;
  position: relative;
  word-break: break-word;
  transition: background-color .25s, color .25s;
}
.message-username {
  display: block;
  font-size: 0.78em;
  font-weight: 700;
  margin-bottom:6px;
}
.message-text {
  font-size: 0.95em;
}
.message-image {
  max-width: 100%;
  border-radius: 6px;
  margin-top: 6px;
  cursor: pointer;
  display: block;
}

/* í¼ */
#chat-form {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  padding: 12px;
  gap:8px;
  background-color: var(--form-bg);
  border-top: 1px solid var(--window-border);
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
}
#username-input{width:90px;padding:8px;border:1px solid var(--input-border);border-radius:6px;background:var(--input-bg);color:var(--input-text)}
#message-input{flex:1;padding:8px;border:1px solid var(--input-border);border-radius:6px}
#font-size-select,#color-picker{padding:6px;border-radius:6px;border:1px solid var(--input-border);cursor:pointer}
#image-upload-label,#bg-upload-label{padding:6px 8px;border:1px solid var(--input-border);background:var(--input-bg);border-radius:6px;cursor:pointer}
#send-button{padding:8px 14px;border:none;background-color:var(--button-bg);color:var(--button-text);border-radius:6px;cursor:pointer;font-weight:700}

/* --- ê¸€ë¼ìŠ¤ëª¨í”¼ì¦˜ ê´€ë ¨ --- */

/* ê¸€ë¼ìŠ¤ í™œì„±í™” í”Œë˜ê·¸ê°€ bodyì— ìˆì„ ë•Œ ë™ì‘ */
body.glass-background .chat-container {
  background-color: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 12px 40px rgba(0,0,0,0.18);
  backdrop-filter: blur(10px) saturate(120%) contrast(95%);
  -webkit-backdrop-filter: blur(10px) saturate(120%) contrast(95%);
}

/* í…Œë§ˆë³„ ì„¸ë¶€ ë³´ì • (chat-containerì— glass í´ë˜ìŠ¤ë„ ë¶™ìŒ) */
.chat-container.glass {
  padding: 6px; /* ì•ˆìª½ ì—¬ë°±ìœ¼ë¡œ ìœ ë¦¬ í…Œë‘ë¦¬ ëŠë‚Œ */
  border-radius: 12px;
  background-clip: padding-box;
}

/* ë©”ì‹œì§€ ë°•ìŠ¤ ê¸€ë¼ìŠ¤ */
body.glass-background .message-item {
  background-color: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.06);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  color: var(--message-text);
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
}

/* ë‹¤í¬ ê³„ì—´ ê¸€ë¼ìŠ¤ ë³´ì • (ìë™ JSë¡œ í† ê¸€ë¨) */
body.glass-dark .chat-container { background-color: rgba(20,20,20,0.32); border-color: rgba(255,255,255,0.06); }
body.glass-dark .message-item { background-color: rgba(10,10,10,0.22); border-color: rgba(255,255,255,0.04); color: #f1f1f1; }

/* í´ë°±: backdrop-filter ë¯¸ì§€ì›ì‹œ ì•½ê°„ì˜ ì˜¤ë²„ë ˆì´ë¡œ ë¹„ìŠ·í•˜ê²Œ */
body.glass-fallback .chat-container::before{
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
  mix-blend-mode: overlay;
  border-radius: inherit;
}

/* ì ‘ê·¼ì„±: í…ìŠ¤íŠ¸ ëŒ€ë¹„ ë³´ì • */
.message-text.light { color: #111; text-shadow: 0 1px 0 rgba(255,255,255,0.03); }
.message-text.dark { color: #f3f3f3; text-shadow: 0 1px 0 rgba(0,0,0,0.35); }

/* ê¸°íƒ€ */
@media (max-width:520px){
  .chat-container{height:90vh;border-radius:8px}
  header{padding:10px 44px}
  #theme-select{left:8px}
  #reset-db-button{right:8px}
}
</style>
</head>
<body class="theme-light">
  <div class="chat-container" id="chat-container">
    <header>
      <select id="theme-select">
        <option value="light">ë¼ì´íŠ¸</option>
        <option value="dark">ë‹¤í¬</option>
        <option value="pastel">íŒŒìŠ¤í…”</option>
      </select>
      <span>Firebase ì‹¤ì‹œê°„ ì±„íŒ…ë°©</span>
      <button id="reset-db-button">ì´ˆê¸°í™”</button>
    </header>

    <div class="chat-window" id="chat-window">
      <ul id="message-list"></ul>
    </div>

    <form id="chat-form">
      <input type="text" id="username-input" placeholder="ì´ë¦„" required />
      <select id="font-size-select">
        <option value="12px">12</option>
        <option value="14px" selected>14</option>
        <option value="16px">16</option>
        <option value="18px">18</option>
        <option value="20px">20</option>
      </select>
      <input type="color" id="color-picker" value="#000000" />
      <input type="file" id="image-upload-input" accept="image/*" style="display:none" />
      <label for="image-upload-input" id="image-upload-label" title="ë©”ì‹œì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ">ğŸ–¼ï¸</label>

      <input type="file" id="bg-upload-input" accept="image/*" style="display:none" />
      <label for="bg-upload-input" id="bg-upload-label" title="ë°°ê²½ ì´ë¯¸ì§€ ë³€ê²½">ğŸŒ†</label>

      <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." required />
      <button type="submit" id="send-button">ì „ì†¡</button>
    </form>
  </div>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      serverTimestamp,
      query,
      orderByChild,
      remove
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB5TAYEoAEawpaYr1tR373OhCYumOc4B7o",
      authDomain: "chat-33290.firebaseapp.com",
      databaseURL: "https://chat-33290-default-rtdb.firebaseio.com",
      projectId: "chat-33290",
      messagingSenderId: "894357766876",
      appId: "1:894357766876:web:bd27cd3f1da7e29b3eaa19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "messages");

    const usernameInput = document.getElementById("username-input");
    const messageInput = document.getElementById("message-input");
    const colorPicker = document.getElementById("color-picker");
    const fontSizeSelect = document.getElementById("font-size-select");
    const messageList = document.getElementById("message-list");
    const chatWindow = document.getElementById("chat-window");
    const themeSelect = document.getElementById("theme-select");
    const resetButton = document.getElementById("reset-db-button");
    const imageUploadInput = document.getElementById("image-upload-input");
    const bgUploadInput = document.getElementById("bg-upload-input");
    const sendButton = document.getElementById("send-button");
    const chatContainer = document.getElementById("chat-container");

    // --- ì´ˆê¸° ë¡œë“œ: í…Œë§ˆ/ë°°ê²½ ë³µì› ---
    document.addEventListener("DOMContentLoaded", () => {
      const savedTheme = localStorage.getItem("chatTheme") || "light";
      document.body.className = `theme-${savedTheme}`;
      themeSelect.value = savedTheme;

      const savedBg = localStorage.getItem("chatBackground");
      if (savedBg) applyBackground(savedBg, false);
    });

    themeSelect.addEventListener("change", (e) => {
      const theme = e.target.value;
      document.body.className = `theme-${theme}`;
      localStorage.setItem("chatTheme", theme);
    });

    // --- ë°°ê²½ ì ìš© í•¨ìˆ˜ ---
    function applyBackground(base64, runBrightnessCheck=true){
      document.body.style.backgroundImage = `url('${base64}')`;
      localStorage.setItem("chatBackground", base64);

      // í”Œë˜ê·¸ ì¶”ê°€
      document.body.classList.add("glass-background");
      chatContainer.classList.add("glass");

      // backdrop-filter ì§€ì› ê²€ì‚¬
      const supportsBackdrop = (window.CSS && (CSS.supports && (CSS.supports("backdrop-filter", "blur(1px)") || CSS.supports("-webkit-backdrop-filter", "blur(1px)"))));

      if (!supportsBackdrop) {
        document.body.classList.add("glass-fallback");
      } else {
        document.body.classList.remove("glass-fallback");
      }

      // ë°ê¸° ì¶”ì • í›„ ë‹¤í¬/ë¼ì´íŠ¸ ë³´ì •
      if (runBrightnessCheck) {
        estimateImageBrightness(base64, (avg) => {
          if (avg === null) return;
          // ì„ê³„ê°’ 120 ê¸°ì¤€
          if (avg < 120) {
            document.body.classList.add("glass-dark");
            // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì–´ë‘¡ê²Œ
            document.querySelectorAll('.message-text').forEach(el=>{
              el.classList.remove('light'); el.classList.add('dark');
            });
          } else {
            document.body.classList.remove("glass-dark");
            document.querySelectorAll('.message-text').forEach(el=>{
              el.classList.remove('dark'); el.classList.add('light');
            });
          }
        });
      }
    }

    // ë°°ê²½ ì—…ë¡œë“œ ì´ë²¤íŠ¸
    bgUploadInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 8 * 1024 * 1024) return alert("8MB ì´í•˜ ì´ë¯¸ì§€ë§Œ ê¶Œì¥í•©ë‹ˆë‹¤.");
      const reader = new FileReader();
      reader.onload = (event) => {
        const base64 = event.target.result;
        applyBackground(base64, true);
      };
      reader.readAsDataURL(file);
    });

    // ì´ë¯¸ì§€ ë©”ì‹œì§€ ì—…ë¡œë“œ
    imageUploadInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      const username = usernameInput.value.trim();
      if (!file || !username) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      if (file.size > 5 * 1024 * 1024) return alert("5MB ì´í•˜ì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

      sendButton.disabled = true;
      sendButton.textContent = "ì—…ë¡œë“œ ì¤‘...";

      const reader = new FileReader();
      reader.onload = (event) => {
        const base64 = event.target.result;
        push(messagesRef, {
          username,
          imageBase64: base64,
          timestamp: serverTimestamp()
        });
        imageUploadInput.value = "";
        sendButton.disabled = false;
        sendButton.textContent = "ì „ì†¡";
      };
      reader.readAsDataURL(file);
    });

    // ë©”ì‹œì§€ ì „ì†¡
    document.getElementById("chat-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const username = usernameInput.value.trim();
      const message = messageInput.value.trim();
      const color = colorPicker.value;
      const size = fontSizeSelect.value;

      if (!username || !message) return alert("ì´ë¦„ê³¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

      push(messagesRef, {
        username,
        message,
        color,
        size,
        timestamp: serverTimestamp()
      });

      messageInput.value = "";
      messageInput.focus();
    });

    // ì‹¤ì‹œê°„ ë©”ì‹œì§€ í‘œì‹œ
    const messagesQuery = query(messagesRef, orderByChild("timestamp"));
    onChildAdded(messagesQuery, (snap) => {
      const data = snap.val();
      const li = document.createElement("li");
      li.className = "message-item";

      const name = document.createElement("span");
      name.className = "message-username";
      name.textContent = data.username || "ìµëª…";
      li.appendChild(name);

      if (data.message) {
        const msg = document.createElement("p");
        msg.className = "message-text";
        msg.textContent = data.message;
        msg.style.color = data.color || getComputedStyle(document.documentElement).getPropertyValue('--message-text');
        msg.style.fontSize = data.size || '14px';
        li.appendChild(msg);
      }

      if (data.imageBase64) {
        const img = document.createElement("img");
        img.className = "message-image";
        img.src = data.imageBase64;
        img.addEventListener("click", () => window.open(data.imageBase64));
        li.appendChild(img);
      }

      messageList.appendChild(li);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    // ì´ˆê¸°í™”
    resetButton.addEventListener("click", () => {
      const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸(ë¹„ë°€ë²ˆí˜¸0207)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if (pw === "ë¹„ë°€ë²ˆí˜¸0207") {
        remove(messagesRef);
        messageList.innerHTML = "";
        alert("ì±„íŒ…ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else if (pw) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    });

    // --- ìœ í‹¸: ì´ë¯¸ì§€ ë°ê¸° ì¶”ì • (ê°„ë‹¨ ìƒ˜í”Œë§) ---
    function estimateImageBrightness(imgBase64, callback) {
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.src = imgBase64;
      img.onload = () => {
        try {
          const canvas = document.createElement('canvas');
          const w = canvas.width = Math.min(100, img.width);
          const h = canvas.height = Math.min(100, img.height);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          const data = ctx.getImageData(0,0,w,h).data;
          let total = 0, count = 0;
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i+1], b = data[i+2];
            const brightness = (0.299*r + 0.587*g + 0.114*b);
            total += brightness; count++;
          }
          const avg = total / count;
          callback(avg);
        } catch (err) {
          callback(null);
        }
      };
      img.onerror = () => callback(null);
    }

    // --- í¸ì˜: ë°°ê²½ ì œê±° ë²„íŠ¼ (ì½˜ì†”ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥) ---
    window.clearChatBackground = function(){
      localStorage.removeItem('chatBackground');
      document.body.style.backgroundImage = '';
      document.body.classList.remove('glass-background','glass-fallback','glass-dark');
      chatContainer.classList.remove('glass');
    };

    // ì ‘ê·¼ì„± ë³´ì •ì´ë‚˜ ì¶”ê°€ ì„¤ì •ì€ ì—¬ê¸°ì„œ ë” í™•ì¥ ê°€ëŠ¥
  </script>
</body>
</html>
